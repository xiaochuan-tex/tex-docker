name: Compile LaTeX Projects
permissions: write-all
on:
  # schedule:
  #   - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:
  push:

jobs:
  compile-projects:
    runs-on: macos-latest
    strategy:
      matrix:
        project: 
          - name: "26李艳芳900题"
            url: "https://www.overleaf.com/project/6938153fa7bfe48a96682edd/download/zip"
          # - name: "26李林880题"
          #   url: "https://www.overleaf.com/project/693952b82ab4edb0635d9a6d/download/zip"
          # - name: "26武忠祥高数严选题"
          #   url: "https://www.overleaf.com/project/69426cb371b752e36a043752/download/zip"
          # - name: "26周洋鑫考点全刷800题"
          #   url: "https://www.overleaf.com/project/694273ca0004cd133c015538/download/zip"
          # - name: "26数据结构做题本"
          #   url: "https://www.overleaf.com/project/693c1bd1b7757c632e5994dc/download/zip"
          # - name: "26操作系统做题本"
          #   url: "https://www.overleaf.com/project/693e433b3844a5658596ea38/download/zip"
          # - name: "26计组做题本"
          #   url: "https://www.overleaf.com/project/695604664269680786fd1eb2/download/zip"
          # - name: "26计网做题本"
          #   url: "https://www.overleaf.com/project/69562d74426968078605fec3/download/zip"
          # - name: "24数学模拟卷"
          #   url: "https://www.overleaf.com/project/69510f5b2a2da77347ae2c01/download/zip"
          #   sub: true
          # - name: "25数学模拟卷"
          #   url: "https://www.overleaf.com/project/695c75ec0dc61c016dfe9644/download/zip"
          #   sub: true
          # - name: "26数学模拟卷"
          #   url: "https://www.overleaf.com/project/695c76428d7895ec31ce2b07/download/zip"
          #   sub: true
          # - name: "数学历年真题"
          #   url: "https://www.overleaf.com/project/69526b934d1938e26c9773a3/download/zip"
          #   sub: true
          # - name: "线性代数陈建龙"
          #   url: "https://www.overleaf.com/project/694a85dbedca3140fd82fa92/download/zip"
          # - name: "茆书概率论"
          #   url: "https://www.overleaf.com/project/695098b32c6528541a5d30a4/download/zip"
          # - name: "黄炜概率论"
          #   url: "https://www.overleaf.com/project/695519924fd1d15c372fa6eb/download/zip"
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      
      - name: Clone source
        run: |
          PROJECT_NAME="${{ matrix.project.name }}"
          PROJECT_URL="${{ matrix.project.url }}"
          
          curl -H "Cookie: ${{ secrets.COOKIE }}" "$PROJECT_URL" -o "$PROJECT_NAME.zip"
          unzip "./$PROJECT_NAME.zip" -d "./$PROJECT_NAME"

      - name: Setup compile script for sub projects
        run: |
          PROJECT_NAME="${{ matrix.project.name }}"
          
          # 复制当前目录下的 scripts/compile.py 到项目目录
          echo "复制 scripts/compile.py 到 ./$PROJECT_NAME/"
          cp "scripts/compile.py" "./$PROJECT_NAME/compile.py"
          chmod +x "./$PROJECT_NAME/compile.py"
          
          # 列出文件确认
          echo "复制完成，项目目录内容："
          ls -la "./$PROJECT_NAME/"
      - name: Cache downloaded file
        uses: actions/cache@v4
        id: cache-software
        with:
          path: /usr/local/texlive/2025
          key: ${{ runner.os }}-texlive2025

      - name: Install TeX Live 2025 Full from ISO
        run: |
          # 创建临时工作目录
          WORK_DIR=$(mktemp -d)
          cd "$WORK_DIR"
          echo "工作目录: $WORK_DIR"
          
          # 下载TeX Live 2025 ISO文件
          echo "开始下载TeX Live 2025 ISO..."
          curl -L -o texlive2025.iso https://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/texlive/Images/texlive2025.iso
          
          # 创建挂载点
          MOUNT_POINT=$(mktemp -d)
          echo "挂载点: $MOUNT_POINT"
          
          # 挂载ISO
          echo "挂载ISO文件..."
          hdiutil attach texlive2025.iso -mountpoint "$MOUNT_POINT" -nobrowse -readonly
          
          # 进入挂载目录
          cd "$MOUNT_POINT"
          
          # 在临时目录创建全量安装配置文件
          cat > "$WORK_DIR/full_install.profile" << 'EOF'
          # TeX Live 2025 全量安装配置
          selected_scheme scheme-full
          TEXDIR /usr/local/texlive/2025
          TEXMFCONFIG ~/.texlive2025/texmf-config
          TEXMFHOME ~/texmf
          TEXMFLOCAL /usr/local/texlive/texmf-local
          TEXMFSYSCONFIG /usr/local/texlive/2025/texmf-config
          TEXMFSYSVAR /usr/local/texlive/2025/texmf-var
          TEXMFVAR ~/.texlive2025/texmf-var
          option_doc 1
          option_src 1
          EOF
          
          # 执行全量安装
          echo "开始安装TeX Live 2025（全量版）..."
          sudo ./install-tl -profile="$WORK_DIR/full_install.profile" -no-interaction
          
          # 卸载ISO
          cd /
          hdiutil detach "$MOUNT_POINT"
          
          # 清理临时目录
          rm -rf "$WORK_DIR" "$MOUNT_POINT"
          
          # 添加TeX Live到PATH
          echo "/usr/local/texlive/2025/bin/universal-darwin" >> $GITHUB_PATH
          
          # 验证安装
          echo "安装完成，验证版本："
          /usr/local/texlive/2025/bin/universal-darwin/pdflatex --version | head -3

      # - name: Compile LaTeX
      #   run: |
      #     export PATH=$PATH:/usr/local/texlive/2025/bin/x86_64-linux
      #     PROJECT_NAME="${{ matrix.project.name }}"
      #     IS_SUB="${{ matrix.project.sub || 'false' }}"
          
      #     cd "./$PROJECT_NAME"
          
      #     # 尝试编译
      #     if [ -f "main.tex" ]; then
      #       latexmk -xelatex -jobname="$PROJECT_NAME" main.tex
      #       cp ./*.pdf ../
      #     fi
      #     if [ -f "pad.tex" ]; then
      #       latexmk -xelatex -jobname="${PROJECT_NAME}_pad" pad.tex
      #       cp ./*.pdf ../
      #     fi
      #     if [ -f "compile.py" ]; then
      #       python ./compile.py --sub="$IS_SUB"
      #       echo "复制所有 PDF 文件到上级目录..."
      #       find . -name "*.pdf" -type f -exec cp {} ../ \;
      #     fi

      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.name }}
          path: ./*.pdf

  collect-all-pdfs:
    runs-on: ubuntu-latest
    needs: compile-projects
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-pdfs
          
      - name: List all PDFs
        run: |
          echo "所有编译完成的PDF文件："
          find ./all-pdfs -name "*.pdf" | sort
          
      - name: Create consolidated artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-latex-projects-pdfs
          path: ./all-pdfs/
          retention-days: 7